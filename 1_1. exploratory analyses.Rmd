---
title: "1_1. exploratory analysis"
author: Dan Weinberger
date: "5/8/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arrow) # for analyze parquet in R
library(tidyr) # for data analysis
library(dplyr) # for data analysis
library(ggplot2) # for plot
library(lubridate) # for creating date variable
```

## Read in the parquet database

```{r} 
NY_pq <- open_dataset("R:/ParquetData/NY", format = "parquet") # a function in arrow package 
```

##Births

Extract the births to a data frame and save it
```{r, eval=F}
NY_births_ids <- NY_pq %>%
  rename(AMONTH='Admission month',AYEAR="Admission year"  ,BWT="Birth weight in grams", ZIP="Patient ZIP Code" ,ID="Visit linkage variable",birth_year="Birth year"  ) %>%
    filter(BWT!='') %>%
    dplyr::select(AMONTH, AYEAR, BWT, ZIP, ID,birth_year)%>%
  collect() %>%
  filter(AYEAR>=2016 & AYEAR<=2019 & !is.na(ID) & birth_year>=2016) #there are a bunch of people with a birth year (and age) that is large  

saveRDS(NY_births_ids, './CONFIDENTIAL/all_births.rds')
```


```{r}
NY_births_ids <- readRDS( './CONFIDENTIAL/all_births.rds') %>%
  mutate(BWT=as.numeric(BWT))
```

How many births per year?
```{r}
NY_births_N <- NY_births_ids %>%
  group_by(AYEAR) %>%
  filter(AYEAR>=2016 & AYEAR<=2019 ) %>%  
  summarize(N_cases = n()) %>%
  collect() %>%
  arrange(AYEAR)

NY_births_N
```


Birthweight is in grams. <2500 is low birthweight; <1500 is very low birthweight
```{r}
hist(NY_births_ids$BWT)
```
identify subsequent hospitalizations for these babies. 53,376 follow up visits for 844,461 births
```{r}
birth_ids <- NY_births_ids %>%pull(ID)

follow_up <- NY_pq %>%
  filter(`Birth year`>=2016) %>% #there are a bunch of people with birth year <<2016
    rename(AMONTH='Admission month',AYEAR="Admission year"  ,BWT="Birth weight in grams", ZIP="Patient ZIP Code" ,ID="Visit linkage variable",
           age_days='Age in days (when age < 1 year)',
           age_months="Age in months (when age < 11 years)" ,
           age_years = "Age in years at admission" ) %>%
filter(ID %in% birth_ids & BWT=='')%>% #identify visits for kids born in a hospital for post-birth visits
  dplyr::select(ID, ZIP, age_days,age_months,age_years,AMONTH,AYEAR, starts_with('ICD-10-CM Diagnosis'))%>%
  collect()%>%
  mutate(age_months= as.numeric(age_months),
         age_years = as.numeric(age_years),
         age_days=as.numeric(age_days),
    agem = if_else(age_years==0, age_days/30.437,age_months))

hist(follow_up$agem)
```



